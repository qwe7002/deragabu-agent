<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deragabu Agent - WebP å…‰æ ‡æµ‹è¯•</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 { font-size: 28px; margin-bottom: 8px; }
        .header p { opacity: 0.85; }

        .content { padding: 30px; }

        .connection-panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            flex: 1;
        }

        .status-indicator.connected { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
        .status-indicator.disconnected { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }

        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-indicator.connected .status-dot { background: #28a745; animation: pulse 2s infinite; }
        .status-indicator.disconnected .status-dot { background: #dc3545; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .controls { display: flex; gap: 10px; flex-wrap: wrap; }

        input[type="text"] {
            flex: 1; min-width: 250px;
            padding: 10px 15px; border: 2px solid #dee2e6;
            border-radius: 6px; font-size: 14px;
        }

        button {
            padding: 10px 20px; border: none; border-radius: 6px;
            font-size: 14px; font-weight: 600; cursor: pointer;
            transition: all 0.2s;
        }
        button:hover:not(:disabled) { transform: translateY(-1px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-danger { background: linear-gradient(135deg, #f85032, #e73827); color: white; }
        .btn-secondary { background: #6c757d; color: white; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white; border: 2px solid #e9ecef;
            border-radius: 10px; padding: 12px; text-align: center;
        }
        .stat-label {
            font-size: 10px; font-weight: 700; color: #6c757d;
            text-transform: uppercase; margin-bottom: 6px;
        }
        .stat-value {
            font-size: 20px; font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* Cursor display area */
        .cursor-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .cursor-section h2 { font-size: 18px; margin-bottom: 15px; color: #333; }

        .scale-controls {
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 15px; flex-wrap: wrap;
        }
        .scale-controls label { font-weight: 600; font-size: 14px; }
        .scale-controls select, .scale-controls input {
            padding: 6px 12px; border: 2px solid #dee2e6;
            border-radius: 6px; font-size: 14px;
        }

        .cursor-display {
            background: repeating-conic-gradient(#e8e8e8 0% 25%, white 0% 50%) 50% / 20px 20px;
            border: 3px solid #dee2e6;
            border-radius: 8px;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .cursor-display img {
            image-rendering: pixelated;
        }

        .cursor-display .empty-state {
            color: #999; font-size: 18px; text-align: center; padding: 40px;
        }

        .cursor-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .cursor-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            min-width: 100px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .cursor-card:hover { border-color: #667eea; transform: translateY(-2px); }
        .cursor-card.active { border-color: #764ba2; background: #f0ebf8; }

        .cursor-card img {
            image-rendering: pixelated;
            display: block;
            margin: 0 auto 8px;
        }

        .cursor-card .card-label {
            font-size: 11px; color: #666;
            word-break: break-all;
        }

        .cursor-info {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
        }
        .info-label { font-size: 10px; font-weight: 700; color: #6c757d; text-transform: uppercase; }
        .info-value { font-size: 13px; font-weight: 600; color: #333; margin-top: 4px; }

        .badge {
            display: inline-block; padding: 3px 10px;
            border-radius: 10px; font-size: 11px; font-weight: 600;
        }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-info { background: #d1ecf1; color: #0c5460; }

        /* Log panel */
        .log-panel { background: #1e1e1e; border-radius: 12px; overflow: hidden; }
        .log-header {
            background: #2d2d2d; padding: 12px 18px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .log-header h2 { color: #d4d4d4; font-size: 14px; }
        .log-btn {
            padding: 5px 10px; font-size: 11px;
            background: #3d3d3d; color: #d4d4d4;
            border: none; border-radius: 4px; cursor: pointer;
        }
        .log-content {
            padding: 12px 18px; max-height: 250px; overflow-y: auto;
            font-family: 'Consolas', monospace; font-size: 12px; line-height: 1.5;
        }
        .log-entry { margin: 2px 0; color: #d4d4d4; }
        .log-entry .timestamp { color: #858585; }
        .log-entry.info { color: #4ec9b0; }
        .log-entry.warn { color: #dcdcaa; }
        .log-entry.error { color: #f48771; }
        .log-entry.success { color: #6a9955; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ–±ï¸ Deragabu Agent - WebP å…‰æ ‡</h1>
            <p>ä¼ è¾“ WebP å…‰æ ‡å›¾åƒï¼Œå®¢æˆ·ç«¯è‡ªè¡Œç¼©æ”¾</p>
        </div>

        <div class="content">
            <div class="connection-panel">
                <div class="status-bar">
                    <div id="statusIndicator" class="status-indicator disconnected">
                        <div class="status-dot"></div>
                        <span id="statusText">æœªè¿æ¥</span>
                    </div>
                </div>
                <div class="controls">
                    <input type="text" id="wsUrl" value="ws://127.0.0.1:9000" placeholder="ws://host:port">
                    <button class="btn-primary" onclick="connect()">è¿æ¥</button>
                    <button class="btn-danger" onclick="disconnect()" id="disconnectBtn" disabled>æ–­å¼€</button>
                    <button class="btn-secondary" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">æ¶ˆæ¯</div>
                    <div class="stat-value" id="msgCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å›¾åƒ(DATA)</div>
                    <div class="stat-value" id="dataCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">åˆ‡æ¢(SIGNAL)</div>
                    <div class="stat-value" id="signalCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ç¼“å­˜å…‰æ ‡</div>
                    <div class="stat-value" id="cacheSize">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ•°æ®é‡</div>
                    <div class="stat-value" id="totalBytes">0 B</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœåŠ¡ç«¯ DPI</div>
                    <div class="stat-value" id="serverDpi">-</div>
                </div>
            </div>

            <div class="cursor-section">
                <h2>ğŸ¯ å½“å‰å…‰æ ‡</h2>
                <div class="scale-controls">
                    <label>å®¢æˆ·ç«¯ç¼©æ”¾:</label>
                    <select id="scaleSelect" onchange="updateDisplayScale()">
                        <option value="auto">è‡ªåŠ¨ (åŒ¹é… DPI)</option>
                        <option value="1">1x (åŸå§‹)</option>
                        <option value="1.5">1.5x</option>
                        <option value="2" selected>2x</option>
                        <option value="3">3x</option>
                        <option value="4">4x</option>
                    </select>
                    <label>å®é™…ç¼©æ”¾:</label>
                    <span id="effectiveScale" style="font-weight:600; color:#764ba2;">2x</span>
                </div>
                <div class="cursor-display" id="cursorDisplay">
                    <div class="empty-state">ç­‰å¾…å…‰æ ‡æ•°æ®...</div>
                </div>
                <div class="cursor-info" id="cursorInfo" style="display:none;">
                    <div class="info-grid" id="cursorInfoGrid"></div>
                </div>
            </div>

            <div class="cursor-section">
                <h2>ğŸ“¦ å·²ç¼“å­˜å…‰æ ‡</h2>
                <div class="cursor-gallery" id="cursorGallery">
                    <div class="empty-state" style="color:#999;">æš‚æ— ç¼“å­˜</div>
                </div>
            </div>

            <div class="log-panel">
                <div class="log-header">
                    <h2>ğŸ“‹ æ—¥å¿—</h2>
                    <button class="log-btn" onclick="clearLog()">æ¸…é™¤</button>
                </div>
                <div class="log-content" id="log"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/protobufjs@7/dist/protobuf.min.js"></script>
    <script>
        // ======== State ========
        let ws = null;
        let stats = { messages: 0, data: 0, signal: 0, bytes: 0 };
        let serverDpiScale = 1.0;
        let CursorMessage = null;

        // cursor_id -> { id, blobUrl, width, height, hotspot_x, hotspot_y, dpi_scale, webpSize }
        const cursorCache = new Map();
        let currentCursorId = null;

        // ======== Protobuf (matches new proto) ========
        const protoDefinition = `
syntax = "proto3";
package cursor;

message CursorMessage {
    MessageType type = 1;
    oneof payload {
        CursorData cursor_data = 2;
        CursorSignal cursor_signal = 3;
    }
    uint64 timestamp = 4;
}

message CursorData {
    string cursor_id = 1;
    bytes image_data = 2;
    int32 width = 3;
    int32 height = 4;
    int32 hotspot_x = 5;
    int32 hotspot_y = 6;
    float dpi_scale = 7;
    bool is_animated = 8;
    uint32 frame_delay_ms = 9;
}

message CursorSignal {
    string cursor_id = 1;
}

enum MessageType {
    MESSAGE_TYPE_UNSPECIFIED = 0;
    MESSAGE_TYPE_CURSOR_DATA = 1;
    MESSAGE_TYPE_CURSOR_SIGNAL = 2;
    MESSAGE_TYPE_CURSOR_HIDE = 3;
    MESSAGE_TYPE_HEARTBEAT = 4;
}`;

        // ======== Init ========
        window.addEventListener('load', () => {
            initProtobuf();
            log('âœ… WebP å…‰æ ‡æµ‹è¯•å·¥å…·å·²å°±ç»ª', 'success');
            log(`ğŸ“ å®¢æˆ·ç«¯ devicePixelRatio: ${window.devicePixelRatio}`, 'info');
        });

        function initProtobuf() {
            try {
                const root = protobuf.parse(protoDefinition, { keepCase: true }).root;
                CursorMessage = root.lookupType('cursor.CursorMessage');
                log('âœ… Protobuf schema loaded', 'info');
            } catch (e) {
                log('âŒ Protobuf load failed: ' + e.message, 'error');
            }
        }

        // ======== WebSocket ========
        function connect() {
            if (!CursorMessage) { log('âŒ Protobuf æœªåˆå§‹åŒ–', 'error'); return; }
            const url = document.getElementById('wsUrl').value.trim();
            log(`ğŸ”Œ è¿æ¥: ${url}...`, 'info');
            updateStatus('connecting');

            ws = new WebSocket(url);
            ws.binaryType = 'arraybuffer';
            ws.onopen = () => {
                log('âœ… å·²è¿æ¥', 'success');
                updateStatus('connected');
                document.getElementById('disconnectBtn').disabled = false;
            };
            ws.onclose = () => {
                log('âš ï¸ æ–­å¼€', 'warn');
                updateStatus('disconnected');
                document.getElementById('disconnectBtn').disabled = true;
            };
            ws.onerror = () => log('âŒ è¿æ¥é”™è¯¯', 'error');
            ws.onmessage = handleMessage;
        }

        function disconnect() {
            if (ws) { ws.close(); ws = null; }
        }

        // ======== Message handling ========
        function handleMessage(event) {
            try {
                const data = new Uint8Array(event.data);
                const msg = CursorMessage.decode(data);
                stats.messages++;
                stats.bytes += data.length;

                switch (msg.type) {
                    case 1: handleCursorData(msg); break;   // CURSOR_DATA
                    case 2: handleCursorSignal(msg); break;  // CURSOR_SIGNAL
                    case 3: handleCursorHide(); break;       // CURSOR_HIDE
                    case 4: break;                           // HEARTBEAT
                }

                updateStatsUI();
            } catch (e) {
                log('âŒ è§£æé”™è¯¯: ' + e.message, 'error');
            }
        }

        function handleCursorData(msg) {
            stats.data++;
            const d = msg.cursor_data;
            if (!d || !d.image_data || d.image_data.length === 0) {
                log('âš ï¸ CURSOR_DATA æ— å›¾åƒæ•°æ®', 'warn');
                return;
            }

            // Create blob URL from WebP data
            const blob = new Blob([d.image_data], { type: 'image/webp' });
            const blobUrl = URL.createObjectURL(blob);

            // Revoke old blob if same id
            const old = cursorCache.get(d.cursor_id);
            if (old && old.blobUrl) URL.revokeObjectURL(old.blobUrl);

            const entry = {
                id: d.cursor_id,
                blobUrl,
                width: d.width,
                height: d.height,
                hotspot_x: d.hotspot_x,
                hotspot_y: d.hotspot_y,
                dpi_scale: d.dpi_scale || 1.0,
                webpSize: d.image_data.length,
            };

            cursorCache.set(d.cursor_id, entry);
            serverDpiScale = entry.dpi_scale;

            log(`ğŸ“¦ æ–°å…‰æ ‡: ${d.cursor_id.substring(0, 16)} | ${d.width}x${d.height} | hotspot(${d.hotspot_x},${d.hotspot_y}) | DPI=${d.dpi_scale.toFixed(2)} | WebP=${d.image_data.length}B`, 'info');

            showCursor(d.cursor_id);
            updateGallery();
            updateDisplayScale();
        }

        function handleCursorSignal(msg) {
            stats.signal++;
            const s = msg.cursor_signal;
            if (!s) return;

            if (cursorCache.has(s.cursor_id)) {
                log(`ğŸ¯ åˆ‡æ¢: ${s.cursor_id.substring(0, 16)}`, 'info');
                showCursor(s.cursor_id);
            } else {
                log(`âš ï¸ æœªçŸ¥å…‰æ ‡ ID: ${s.cursor_id}`, 'warn');
            }
        }

        function handleCursorHide() {
            log('ğŸ‘» å…‰æ ‡éšè—', 'warn');
            currentCursorId = null;
            const display = document.getElementById('cursorDisplay');
            display.innerHTML = '<div class="empty-state">å…‰æ ‡å·²éšè—</div>';
            document.getElementById('cursorInfo').style.display = 'none';
        }

        // ======== Display ========
        function showCursor(cursorId) {
            const entry = cursorCache.get(cursorId);
            if (!entry) return;

            currentCursorId = cursorId;
            const scale = getEffectiveScale(entry);
            const displayW = Math.round(entry.width * scale);
            const displayH = Math.round(entry.height * scale);

            const display = document.getElementById('cursorDisplay');
            display.innerHTML = `<img src="${entry.blobUrl}"
                width="${displayW}" height="${displayH}"
                title="${entry.id}"
                style="image-rendering: pixelated;">`;

            // Show info
            const info = document.getElementById('cursorInfo');
            info.style.display = 'block';
            document.getElementById('cursorInfoGrid').innerHTML = `
                <div>
                    <div class="info-label">å…‰æ ‡ ID</div>
                    <div class="info-value">${entry.id}</div>
                </div>
                <div>
                    <div class="info-label">åŸå§‹å°ºå¯¸</div>
                    <div class="info-value">${entry.width} Ã— ${entry.height}</div>
                </div>
                <div>
                    <div class="info-label">æ˜¾ç¤ºå°ºå¯¸</div>
                    <div class="info-value">${displayW} Ã— ${displayH}</div>
                </div>
                <div>
                    <div class="info-label">çƒ­ç‚¹</div>
                    <div class="info-value">(${entry.hotspot_x}, ${entry.hotspot_y})</div>
                </div>
                <div>
                    <div class="info-label">æœåŠ¡ç«¯ DPI</div>
                    <div class="info-value"><span class="badge badge-info">${entry.dpi_scale.toFixed(2)}</span></div>
                </div>
                <div>
                    <div class="info-label">æ˜¾ç¤ºç¼©æ”¾</div>
                    <div class="info-value"><span class="badge badge-success">${scale.toFixed(2)}x</span></div>
                </div>
                <div>
                    <div class="info-label">WebP å¤§å°</div>
                    <div class="info-value">${entry.webpSize} B</div>
                </div>
            `;

            // Update gallery active state
            document.querySelectorAll('.cursor-card').forEach(card => {
                card.classList.toggle('active', card.dataset.id === cursorId);
            });
        }

        function getEffectiveScale(entry) {
            const sel = document.getElementById('scaleSelect').value;
            if (sel === 'auto') {
                // Auto: compensate for server DPI, match client devicePixelRatio
                // If server captured at 1.5x DPI and client is 1x, scale down by 1/1.5
                // If server captured at 1x DPI and client is 2x, scale up by 2
                const clientDpr = window.devicePixelRatio || 1;
                const serverDpi = entry ? entry.dpi_scale : serverDpiScale;
                return clientDpr / serverDpi;
            }
            return parseFloat(sel);
        }

        function updateDisplayScale() {
            const entry = currentCursorId ? cursorCache.get(currentCursorId) : null;
            const scale = getEffectiveScale(entry);
            document.getElementById('effectiveScale').textContent = scale.toFixed(2) + 'x';
            document.getElementById('serverDpi').textContent = serverDpiScale.toFixed(2);

            if (entry) showCursor(currentCursorId);
        }

        function updateGallery() {
            const gallery = document.getElementById('cursorGallery');
            gallery.innerHTML = '';

            for (const [id, entry] of cursorCache) {
                const card = document.createElement('div');
                card.className = 'cursor-card' + (id === currentCursorId ? ' active' : '');
                card.dataset.id = id;
                card.onclick = () => showCursor(id);
                card.innerHTML = `
                    <img src="${entry.blobUrl}" width="${Math.max(entry.width, 32)}" height="${Math.max(entry.height, 32)}"
                         style="image-rendering: pixelated;">
                    <div class="card-label">${id.substring(0, 12)}</div>
                    <div class="card-label">${entry.width}Ã—${entry.height} | ${entry.webpSize}B</div>
                `;
                gallery.appendChild(card);
            }

            if (cursorCache.size === 0) {
                gallery.innerHTML = '<div style="color:#999; padding:20px;">æš‚æ— ç¼“å­˜</div>';
            }
        }

        // ======== Stats ========
        function updateStatsUI() {
            document.getElementById('msgCount').textContent = stats.messages;
            document.getElementById('dataCount').textContent = stats.data;
            document.getElementById('signalCount').textContent = stats.signal;
            document.getElementById('cacheSize').textContent = cursorCache.size;
            document.getElementById('serverDpi').textContent = serverDpiScale.toFixed(2);

            const b = stats.bytes;
            document.getElementById('totalBytes').textContent =
                b < 1024 ? b + ' B' :
                b < 1048576 ? (b / 1024).toFixed(1) + ' KB' :
                (b / 1048576).toFixed(2) + ' MB';
        }

        function updateStatus(state) {
            const el = document.getElementById('statusIndicator');
            const txt = document.getElementById('statusText');
            el.className = 'status-indicator ' + (state === 'connecting' ? 'disconnected' : state);
            txt.textContent = state === 'connected' ? 'å·²è¿æ¥' : state === 'connecting' ? 'è¿æ¥ä¸­...' : 'æœªè¿æ¥';
        }

        // ======== Log ========
        function log(message, type = 'info') {
            const el = document.getElementById('log');
            const ts = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.innerHTML = `<span class="timestamp">[${ts}]</span> ${escapeHtml(message)}`;
            el.appendChild(entry);
            el.scrollTop = el.scrollHeight;
            // Keep log size manageable
            while (el.children.length > 500) el.removeChild(el.firstChild);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('ğŸ“ æ¸…é™¤å®Œæˆ', 'info');
        }

        function escapeHtml(text) {
            const d = document.createElement('div');
            d.textContent = text;
            return d.innerHTML;
        }
    </script>
</body>
</html>
